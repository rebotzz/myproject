# 游戏：幽灵逃生

[参考教程](https://cppgamedev.top/courses/modular-ghost-escape)

## 简介

- 1.使用`SDL3`和`glm`
```
    glm编译

    SDL3_mixer编译
```
- 2.新的`代码框架`
![游戏框架设计](showing/03-游戏框架设计1.png)
![游戏框架设计](showing/03-游戏框架设计3.png)
![游戏框架设计](showing/03-游戏框架设计4.png)
![游戏框架设计](showing/03-游戏框架设计5.png)
![游戏框架设计](showing/08-自动挂载功能2.png)

- 3.使用`空间四叉树`优化碰撞检测
```
    又要代码重构了，

	出了好多bug，一天都在找bug，
	不好定位，改了一些地方，但是好像不对。
```

## Debug
```
    1.cmake添加源文件
    file(GLOB_RECURSE my_sources src/*.cpp)

    2.为了方便，我把三方库放在文件路径下，没有添加环境变量，
    所以，在可执行文件路径下需要放置库文件.dll(windows环境)

    3. 野指针/迭代器失效: 
    delete this，如果在类中delete this之后还有执行内容，会野指针。解决：改用标记setCanRemove，下次遍历初delete  
    遍历途中插入新的元素,vector可能扩容释放旧空间。解决：放入临时容器，下次遍历初push    safeAddChild
    场景切换导致资源清理问题， 放入临时变量，下次遍历初change    safeChangeScene
```

## Debug-ing
```

武器类（fixed: bug！） 
状态栏
ui界面：按键。 
场景切换: 标题场景	画面比例缩放问题。	摄像机位置限制bug.
音效添加


按键其他：时间停止、退出、重新开始
按键类。	

解决事件穿透，事件拦截处理； 事件处理的优先级。--- 怎么决定？ 在容器中的先后顺序； 
不，更合理的是用不同容器分隔，纯粹功能容器 > 屏幕对象容器 > 世界对象容器


星空背景 + 背景纵深

游戏内部鼠标绘制 + 屏幕缩放比列解决


todo:
范围检测：
场景只绘制屏幕范围元素
空间四叉树。
特效类优化，提高泛用性，一如敌人生成特效。
spell优化，提高泛用性。


一段时间后，没有元素的网格回收，元素过少的网格合并。
目前四叉树没有加入碰撞盒子移动改变功能。 等待加入。

智能指针 + vector： 所以vector开辟空间后，使用定位new初始化，结束时调用析构

碰撞盒子持有对方引用，需要观察者？

栈溢出。 erase 部分是否清理vector
碰撞管理器安全插入问题：下一次更新再插入		确实是这个问题！

新的问题： 敌人画面抖动
碰撞盒子更新频率。--》 或许需要改为碰撞盒子出入边界。而不是彻底重构

因为没有调用碰撞盒子的更新（遍历列表更新位置等），
只有处理碰撞时更新了。还有或许重构四叉树代价太大，帧间隔过大以至于画面抖动


还是存在野指针问题。。。
--------------------------------------------难道需要safeErase???
错误原因： 重复delete两次。
而且引用计数竟然出现了负数。我改了一下，如果出现负数，就不delete。
暂时没有报错了，但是为什么？
刚创建时是0，应该还是re insert重新分配的问题。
不，我发现所有引用计数出现负数的都是法术。看来法术休要修改。是吗？不能确定。

角色莫名其妙扣血，可能原因。子弹没有销毁。看不见的子弹还在伤害玩家。
那么有可能内存泄漏 已修改。子弹失效后没setCanRemove()


还是有问题，我决定暂时搁浅。保留碰撞管理器。
但改用双重for检测碰撞----------------------------------------------TODO

todo: 有了碰撞可以实现反弹、推动等物理效果。


！！！！！！！！！！！！！！
需要观察者。一直以来，并不同步。
碰撞管理器删了，但是没有同步给CollideBoxWrapper

```


## 吐槽
```
总算写完了，
虽然代码采用自动挂载、自动处理的架构方便不少。
但也意味着和我之前习惯的写法有些不同，之前我习惯东西都放一起。
只有handleEvent, update, render
而现在，我需要考虑怎么把东西拆分为主体+组件。
理解和习惯这种模式花费了一些时间。虽然代码量增长不多，但是比上一个SDL_Shooter难写多了。
当我看完一遍教程后，有种感觉忘记的差不多了……(￣_￣|||)
然后呢，自己借着部分印象 + 俺寻思可以这样写 = 最终的成果有点地方可能和原教程差距较大。
接下来，该看看原教程代码和自己的区别。
```